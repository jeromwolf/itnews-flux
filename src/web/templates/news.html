{% extends "base.html" %}

{% block title %}News - Tech News Digest{% endblock %}

{% block content %}
<h1 style="margin-bottom: 2rem;">ðŸ“° Tech News</h1>

<!-- Controls -->
<div class="card" style="margin-bottom: 2rem;">
    <div class="card-body">
        <div style="display: flex; gap: 1rem; align-items: flex-end; flex-wrap: wrap;">
            <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                <label class="form-label">Sources</label>
                <select id="sources" class="form-select">
                    <option value="techcrunch,theverge">TechCrunch + The Verge</option>
                    <option value="techcrunch">TechCrunch</option>
                    <option value="theverge">The Verge</option>
                </select>
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                <label class="form-label">Max Age (hours)</label>
                <input type="number" id="max-age" class="form-input" value="24" min="1" max="168">
            </div>
            <div class="form-group" style="flex: 1; min-width: 150px; margin-bottom: 0;">
                <label class="form-label">Limit</label>
                <input type="number" id="limit" class="form-input" value="10" min="1" max="50">
            </div>
            <button onclick="loadNews()" class="btn btn-primary">ðŸ”„ Refresh</button>
        </div>
    </div>
</div>

<!-- Selected News Actions -->
<div id="selected-actions" style="display: none; margin-bottom: 2rem;">
    <div class="card" style="background: #dbeafe; border: 2px solid var(--primary-color);">
        <div class="card-body">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <strong><span id="selected-count">0</span> articles selected</strong>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button onclick="clearSelection()" class="btn btn-secondary">Clear Selection</button>
                    <button onclick="createVideo()" class="btn btn-success">ðŸŽ¬ Create Video</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- News List -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">News Articles</h2>
        <span id="news-count" style="color: var(--text-secondary);">0 articles</span>
    </div>
    <div class="card-body">
        <div id="news-list">
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading news...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedNews = new Set();
let allNews = [];

async function loadNews() {
    try {
        const sources = document.getElementById('sources').value;
        const maxAge = parseInt(document.getElementById('max-age').value);
        const limit = parseInt(document.getElementById('limit').value);

        document.getElementById('news-list').innerHTML = `
            <div class="loading">
                <div class="spinner"></div>
                <p>Fetching news...</p>
            </div>
        `;

        const data = await API.News.getNews({ sources, max_age_hours: maxAge, limit });
        allNews = data.news;

        document.getElementById('news-count').textContent = `${data.total} articles`;

        if (data.news.length === 0) {
            document.getElementById('news-list').innerHTML = `
                <p style="text-align: center; color: var(--text-secondary); padding: 2rem;">
                    No news articles found
                </p>
            `;
            return;
        }

        const newsHtml = data.news.map(news => `
            <div class="news-item ${selectedNews.has(news.id) ? 'selected' : ''}"
                 onclick="toggleNews('${news.id}')"
                 id="news-${news.id}">
                ${news.image_url
                    ? `<img src="${news.image_url}" alt="${news.title}" class="news-thumbnail" onerror="this.style.display='none'">`
                    : '<div class="news-thumbnail" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">ðŸ“°</div>'
                }
                <div class="news-content">
                    <div class="news-title">${news.title}</div>
                    <div class="news-meta">
                        <span class="badge badge-info">${news.category}</span>
                        <span>${news.source}</span>
                        <span>Score: ${news.score.toFixed(1)}</span>
                        <span>${utils.formatDate(news.published_at)}</span>
                    </div>
                    <div class="news-summary">${news.summary}</div>
                </div>
            </div>
        `).join('');

        document.getElementById('news-list').innerHTML = newsHtml;
        updateSelectedUI();

        utils.showToast(`Loaded ${data.total} news articles`, 'success');
    } catch (error) {
        console.error('Error loading news:', error);
        document.getElementById('news-list').innerHTML = `
            <p style="text-align: center; color: var(--danger-color); padding: 2rem;">
                Error loading news: ${error.message}
            </p>
        `;
        utils.showToast('Error loading news', 'error');
    }
}

function toggleNews(newsId) {
    if (selectedNews.has(newsId)) {
        selectedNews.delete(newsId);
        document.getElementById(`news-${newsId}`).classList.remove('selected');
    } else {
        if (selectedNews.size >= 5) {
            utils.showToast('Maximum 5 articles can be selected', 'error');
            return;
        }
        selectedNews.add(newsId);
        document.getElementById(`news-${newsId}`).classList.add('selected');
    }
    updateSelectedUI();
}

function clearSelection() {
    selectedNews.clear();
    document.querySelectorAll('.news-item').forEach(item => {
        item.classList.remove('selected');
    });
    updateSelectedUI();
}

function updateSelectedUI() {
    const count = selectedNews.size;
    document.getElementById('selected-count').textContent = count;
    document.getElementById('selected-actions').style.display = count > 0 ? 'block' : 'none';
}

async function createVideo() {
    if (selectedNews.size === 0) {
        utils.showToast('Please select at least one news article', 'error');
        return;
    }

    const newsIds = Array.from(selectedNews);
    const uploadToYoutube = confirm('Upload to YouTube when ready?');

    try {
        const result = await API.Videos.createVideo(newsIds, uploadToYoutube);
        utils.showToast(`Video creation started: ${result.id}`, 'success');

        // Redirect to videos page after 2 seconds
        setTimeout(() => {
            window.location.href = '/videos';
        }, 2000);
    } catch (error) {
        console.error('Error creating video:', error);
        utils.showToast('Error creating video: ' + error.message, 'error');
    }
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadNews);
</script>
{% endblock %}
